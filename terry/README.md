# Terry
Turns Snoo-py from a command line tool into a web tool

## Running in Dev

### Configure Dev environment
- Create the file `local_settings.py` in the `app_settings/` directory, where the file contents include:
    - `DEBUG = True`
    - `HOT_LOAD = True`
    - `GITHUB_LOGIN_CLIENT_ID = 'cdc36eecb9d932cf7da7'`
    - `GITHUB_LOGIN_SECRET = '6040be5f7b7217d1d16450c469c470d70aa7f777'`
    - `GITHUB_OAUTH_CLIENT_ID = '1ec3396d4415237301c3'`
    - `GITHUB_OAUTH_SECRET = 'f2fcd1b5a680b6b07358b84103be8f9e5cdf6589'`
    - `GITHUB_APP_ID = 'Iv1.5a4e74acf6c5c02d'`
    - `GITHUB_APP_SECRET = '96417e0e44f5172e86de95b7fdfa7ed7f2c56c57'`
    - `BITBUCKET_LOGIN_CLIENT_ID = 'vEBMAJpmsuhQrNrfaG'`
    - `BITBUCKET_LOGIN_SECRET = '6XuaYFB9eGBAscvcJh2WFTJ9QUHYc4xj'`
    - `BITBUCKET_OAUTH_CLIENT_ID = 'Y8rgR9wTpRAVduPXNk'`
    - `BITBUCKET_OAUTH_SECRET = 'XNq6a9cqjRL8JPkr5xWR8kD4FerQpdwc'`
    - `GITLAB_LOGIN_CLIENT_ID = 'fae1f534749a5522e8e528b226f9168d6024342ac15f3de9380301e25cc67f45'`
    - `GITLAB_LOGIN_SECRET = '2143b77f7a9bc2174d1a63e71925adf9d5a91dd050573f917b82a17bf6635f80'`
    - `GITLAB_OAUTH_CLIENT_ID = 'fa46b9d456db9d8588ec264b31f744f4888eac7d81534dffa13e20f986b70ba3'`
    - `GITLAB_OAUTH_SECRET = '6a67c123795f6a76b49ee54f0fdbeba258de0debb60b15750b4d80da97f4e0e1'`
    - `SLACK_WEBHOOK = '...'` you can create one [here](https://slack.com/apps/new/A0F7XDUAZ-incoming-webhooks)
    - `SLACK_CHANNEL = '...'` (name slack channel to send messages to: #dev, #general, @admin etc)
- Create the file `secret.yml` in the ` ansible/vars/` directory, where the file contents include:
```
AWS_SECRET_ACCESS_KEY: ...
AWS_ACCESS_KEY_ID: ...
SENDGRID_API_KEY: [required]
db_password: ...
public_key: ~/.ssh/<your_rsa>.pub
superuser_username: [required]
superuser_password: [required]
```

### Provisioning
- Install [Ansible](http://docs.ansible.com/ansible/intro_installation.html)
- `$ vagrant up`
- `$ vagrant provision`

### Django server
- `$ vagrant up`
- `$ vagrant ssh`
- `$ cd /srv/terry`
- `$ source ../venv/bin/activate`
- `$ python manage.py createsuperuser`
- `$ python manage.py runserver 0.0.0.0:8001`
- Login to admin as socket requires a session_key, which is generated by a logged in user.

_Convenience one-liner:_ `cd /srv/terry && source ../venv/bin/activate && python manage.py runserver 0.0.0.0:8001`

### Socket server
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/terry/realtime/node`
- `$ npm install`
- `$ node server.js`

_Convenience one-liner:_ `cd /srv/terry/realtime/node && node server.js`

### Celery worker
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/terry`
- `$ source ../venv/bin/activate`
- `$ celery -A terry worker -l info`

_Convenience one-liner:_ `cd /srv/terry && source ../venv/bin/activate && celery -A terry worker -l info --discard`

### Compile front end.
Outside vagrant environment
- `$ cd portal/static/js`
- `$ npm install`
- `$ npm run dist` for js file.
    - Or for hot reload:
    - `$ npm start`

## Deploy on AWS
- Check that a proper AMI exists in the region (if not, create an Ubuntu one)
    - For `us-west-2` (Oregon) use the following: `ami-66880e06`
    - For `ca-central-1` (Canada) use the following: `ami-ff902d9b`
- Edit `ansible/vars/base.yml` and set the proper `ami_id` and the `region`
- `$ sudo pip install boto`
- `$ sudo pip install awscli`
- `$ aws configure` and fill in AWS credentials (found in IAM)
- Identify the ssh key registered in github, or generate and add a new one:
    - https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/
    - Replace `<your_rsa>` below with the name of this key
- Fill the AWS credentials and ssh key in `ansible/vars/secret.yml`

```
AWS_SECRET_ACCESS_KEY: ...
AWS_ACCESS_KEY_ID: ...
SENDGRID_API_KEY: ...
SLACK_WEBHOOK: ...
SLACK_CHANNEL: ...
GITHUB_LOGIN_CLIENT_ID: ...
GITHUB_LOGIN_SECRET: ...
GITHUB_OAUTH_CLIENT_ID: ...
GITHUB_OAUTH_SECRET: ...
GITHUB_APP_ID: ...
GITHUB_APP_SECRET: ...
BITBUCKET_LOGIN_CLIENT_ID: ...
BITBUCKET_LOGIN_SECRET: ...
BITBUCKET_OAUTH_CLIENT_ID: ...
BITBUCKET_OAUTH_SECRET: ...
GITLAB_LOGIN_CLIENT_ID: ...
GITLAB_LOGIN_SECRET: ...
GITLAB_OAUTH_CLIENT_ID: ...
GITLAB_OAUTH_SECRET: ...
db_password: ...
public_key: ~/.ssh/<your_rsa>.pub
superuser_username: ...
superuser_password: ...
env: ...
ami_id: ...
region: ...
```

- `$ ssh-add ~/.ssh/<your_rsa>`
- `$ cd ansible && ansible-playbook deploy.yml -e "env=deploy"` (for the instance called __"terry-deploy"__)
