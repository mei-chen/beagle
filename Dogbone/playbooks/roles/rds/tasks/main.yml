---

- name: Create RDS instance
  rds:
    command: create
    region: "{{ region | mandatory }}"
    instance_name: "{{ db_name | replace('_', '-')}}"
    size: 200
    db_engine: postgres
    instance_type: "db.{{ instance_type | default('t2.small') }}"
    db_name: "{{ db_name }}"
    username: "{{ db_user | default('postgres') }}"
    # Password is only actually used first time, on DB creation
    password: "{{ db_password | default(lookup('password', '/tmp/rds_root_password length=50 chars=ascii_letters,digits,hexdigits')) }}"
    wait: true
    wait_timeout: 600
    vpc_security_groups: "{{ beagle_security_group.group_id | mandatory}}"
  register: rds

- name: Create RDS host group for later roles
  add_host:
    name: "{{ rds.instance.endpoint }}:{{ rds.instance.port }}"
    changed: "{{ rds.changed }}"
    username: "{{ rds.instance.username }}"
    password: "{{ db_password | default(lookup('password', '/tmp/rds_root_password length=50 chars=ascii_letters,digits,hexdigits')) }}"
    db_name: "{{ db_name }}"
    groups: "rds"
