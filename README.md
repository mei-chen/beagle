

# Beagle
## Running in Dev

### Vagrant environment
- Install [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/index.html), [Vagrant](https://www.vagrantup.com/), [VirtualBox](https://www.virtualbox.org/)
- `$ vagrant up`
- Make sure to run the vagrant environment in the base beagle folder. We then have separate provisioners for Kibble, Spot and Dogbone using ansible playbooks.

## Configure Kibble
### Configure Dev envirnoment
- Create the file `local_settings.py` in the `Kibble/kibble/app_settings/` directory, where the file contents include:
    - `DEBUG = True`
    - `HOT_LOAD = False` (TODO: Fix for True)
- Create the file `secret.yml` in the ` ansible/vars/` directory, where the file contents include (should be created already):

```
AWS_SECRET_ACCESS_KEY: ... (if you omit this and 3 below files will be saved locally)
AWS_ACCESS_KEY_ID: ...
AWS_STORAGE_BUCKET_NAME: ...
AWS_S3_REGION_NAME: ...
DROPBOX_APP_KEY: ...
DROPBOX_APP_SECRET: ...
GOOGLE_DRIVE_CLIENT_ID: ...
GOOGLE_DRIVE_CLIENT_SECRET: ...
SENDGRID_API_KEY: [required]
db_password: ...
public_key: ~/.ssh/<your_rsa>.pub
superuser_username: [required]
superuser_password: [required]
```

### Provisioning
- `$ vagrant provision --provision-with kibble`

### Django server
- `$ vagrant ssh`
- `$ cd /srv/kibble`
- `$ source ../venv/bin/activate`
- `$ python manage.py createsuperuser`
- `$ python manage.py runserver 0.0.0.0:8001`
- Login to admin as socket requires a session_key, which is generated by a logged in user.

_Convenience one-liner:_ `cd /srv/kibble && source ../venv/bin/activate && python manage.py runserver 0.0.0.0:8001`

### Socket server
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/kibble/realtime/node`
- `$ npm install`
- `$ node server.js`

_Convenience one-liner:_ `cd /srv/kibble/realtime/node && node server.js`

### Celery beat
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/kibble`
- `$ source ../venv/bin/activate`
- `$ celery -A kibble beat -l info`

_Convenience one-liner:_ `cd /srv/kibble && source ../venv/bin/activate && celery -A kibble beat -l info`

Note: required for enabling the online cloud folder watcher (otherwise optional)

### Celery worker
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/kibble`
- `$ source ../venv/bin/activate`
- `$ celery -A kibble worker -l info --discard`

_Convenience one-liner:_ `cd /srv/kibble && source ../venv/bin/activate && celery -A kibble worker -l info --discard`

### Compile front end.
Outside vagrant environment
- `$ cd portal/static/js`
- `$ npm install`
- `$ npm run dist` for js file.
    - Or for hot reload:
    - `$ npm start`

If you use npm run dist, make sure to run collectstatic to group up the static files.