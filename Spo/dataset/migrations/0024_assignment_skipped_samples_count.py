# -*- coding: utf-8 -*-
# Generated by Django 1.10.5 on 2017-11-17 11:21
from __future__ import unicode_literals

from django.db import migrations, models


def update_skipped_samples_count_of_legacy_assignments(apps, schema_editor):
    """
    Replaces null (i.e. None) values from the skipped_samples_count
    field by the actual numbers of skipped samples for each legacy assignment.
    """

    try:
        Assignment = apps.get_model('dataset', 'Assignment')
        for assignment in Assignment.objects.all():
            assignment.skipped_samples_count = \
                sum(stage['labels'].count(None) for stage in (assignment.stages or []))
            assignment.save()
    except LookupError:
        pass


class Migration(migrations.Migration):

    dependencies = [
        ('dataset', '0023_assignment_score'),
    ]

    operations = [
        migrations.AddField(
            model_name='assignment',
            name='skipped_samples_count',
            field=models.IntegerField(blank=True, null=True, verbose_name='Skipped samples count'),
        ),

        migrations.RunPython(
            update_skipped_samples_count_of_legacy_assignments,
            migrations.RunPython.noop,  # no reverse code needed
        ),
    ]
