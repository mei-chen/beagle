# -*- coding: utf-8 -*-
# Generated by Django 1.10.5 on 2017-11-03 19:26
from __future__ import unicode_literals

from django.db import migrations, models


def update_stages_and_labeled_samples_count_of_legacy_labeling_tasks(apps, schema_editor):
    """
    Replaces null (i.e. None) values from the stages_count and labeled_samples_count
    fields by the actual numbers of stages and labeled samples for each legacy labeling task.
    """

    try:
        LabelingTask = apps.get_model('dataset', 'LabelingTask')
        for labeling_task in LabelingTask.objects.all():
            labeling_task.stages_count = len(labeling_task.stages or [])
            labeling_task.labeled_samples_count = \
                sum(len(stage['texts']) for stage in (labeling_task.stages or []))
            labeling_task.save()
    except LookupError:
        pass


class Migration(migrations.Migration):

    dependencies = [
        ('dataset', '0016_dataset_samples_count'),
    ]

    operations = [
        migrations.AddField(
            model_name='labelingtask',
            name='labeled_samples_count',
            field=models.IntegerField(blank=True, null=True, verbose_name='Labeled samples count'),
        ),
        migrations.AddField(
            model_name='labelingtask',
            name='stages_count',
            field=models.IntegerField(blank=True, null=True, verbose_name='Stages count'),
        ),

        migrations.RunPython(
            update_stages_and_labeled_samples_count_of_legacy_labeling_tasks,
            migrations.RunPython.noop,  # no reverse code needed
        ),
    ]
