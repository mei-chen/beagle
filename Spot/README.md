# Spot
Bringing ML classifier creation to the plebs

## Running in Dev

### Configure Dev environment
- Create the file `local_settings.py` in the `app_settings/` directory, where the file contents include:
```
DEBUG = True
HOT_LOAD = True  # (optional)

AWS_ACCESS_KEY_ID = '...'
AWS_SECRET_ACCESS_KEY = '...'
```
- Create the file `secret.yml` in the ` ansible/vars/` directory, where the file contents include:
```
AWS_SECRET_ACCESS_KEY: ...
AWS_ACCESS_KEY_ID: ...
SENDGRID_API_KEY: [required]
db_password: ...
public_key: ~/.ssh/<your_rsa>.pub
superuser_username: [required]
superuser_password: [required]
```

### Provisioning
- Install [Ansible](http://docs.ansible.com/ansible/intro_installation.html)
- `$ vagrant up`
- `$ vagrant provision`

### Django server
- `$ vagrant up`
- `$ vagrant ssh`
- `$ cd /srv/spot`
- `$ source ../venv/bin/activate`
- `$ python manage.py createsuperuser`
- `$ python manage.py runserver 0.0.0.0:8001`
- Login to admin as socket requires a session_key, which is generated by a logged in user.

_Convenience one-liner:_ `cd /srv/spot && source ../venv/bin/activate && python manage.py runserver 0.0.0.0:8001`

### Socket server
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/spot/realtime/node`
- `$ npm install`
- `$ node server.js`

_Convenience one-liner:_ `cd /srv/spot/realtime/node && node server.js`

### Celery worker
In new terminal run:
- `$ vagrant ssh`
- `$ cd /srv/spot`
- `$ source ../venv/bin/activate`
- `$ celery -A spot worker -l info`

_Convenience one-liner:_ `cd /srv/spot && source ../venv/bin/activate && celery -A spot worker -l info --discard`

### Compile front end.
Outside vagrant environment
- `$ cd portal/static/js`
- `$ npm install`
- `$ npm run dist` for js file.
    - Or for hot reload:
    - `$ npm start`

## Deploy on AWS
- Check that a proper AMI exists in the region (if not, create an Ubuntu one)
    - For `us-west-2` (Oregon) use the following: `ami-66880e06`
    - For `ca-central-1` (Canada) use the following: `ami-ff902d9b`
- Edit `ansible/vars/base.yml` and set the proper `ami_id` and the `region`
- `$ sudo pip install boto`
- `$ sudo pip install awscli`
- `$ aws configure` and fill in AWS credentials (found in IAM)
- Identify the ssh key registered in github, or generate and add a new one:
    - https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/
    - Replace `<your_rsa>` below with the name of this key
- Fill the AWS credentials and ssh key in `ansible/vars/secret.yml`

```
// Mandatory
env: ...
ami_id: ...
region: ...
public_key: ~/.ssh/<your_rsa>.pub
db_password: ...
AWS_SECRET_ACCESS_KEY: ...
AWS_ACCESS_KEY_ID: ...

// Optional
SENDGRID_API_KEY: ... // Set to null
superuser_username: ... // If create_superuser is true in base.yml
superuser_password: ... // If create_superuser is true in base.yml
```

- `$ ssh-add ~/.ssh/<your_rsa>`
- `$ cd ansible && ansible-playbook deploy.yml -e "env=deploy"` (for the instance called __"spot-deploy"__)
